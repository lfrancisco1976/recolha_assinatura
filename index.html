<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Recolher Assinatura</title>
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 10px;
    background: #f5f5f5;
    font-family: Arial, sans-serif;
  }
  h2 {
    text-align: center;
    margin-bottom: 10px;
  }
  canvas {
    border: 2px solid #000;
    border-radius: 10px;
    background: transparent;
    touch-action: none;
    width: 100%;
    max-width: 500px;
    height: 200px;
    margin-bottom: 10px;
  }
  button {
    margin: 5px;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    background-color: #007BFF;
    color: white;
    font-size: 14px;
    cursor: pointer;
    flex: 1;
  }
  button:hover {
    background-color: #0056b3;
  }
  .buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 5px;
    width: 100%;
    max-width: 500px;
  }
</style>
</head>
<body>
<h2>Recolher Assinatura</h2>
<canvas id="signature"></canvas>
<div class="buttons">
  <button id="clearBtn">Limpar</button>
  <button id="undoBtn">Anular Ãºltimo</button>
  <button id="uploadBtn">Enviar para Sheets</button>
</div>

<script>
const canvas = document.getElementById('signature');
const ctx = canvas.getContext('2d');
let drawing = false;
let paths = [];
let currentPath = [];

// Ajusta tamanho do canvas para mobile
function resizeCanvas() {
  const ratio = window.devicePixelRatio || 1;
  const width = canvas.clientWidth * ratio;
  const height = 200 * ratio;
  canvas.width = width;
  canvas.height = height;
  ctx.scale(ratio, ratio);
  redraw();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

ctx.lineWidth = 2;
ctx.lineJoin = 'round';
ctx.lineCap = 'round';
ctx.strokeStyle = '#000';

function getPointerPos(e) {
  const rect = canvas.getBoundingClientRect();
  if(e.touches) {
    return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
  }
  return { x: e.offsetX, y: e.offsetY };
}

canvas.addEventListener('pointerdown', e => {
  drawing = true;
  currentPath = [];
  const pos = getPointerPos(e);
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
  currentPath.push(pos);
});
canvas.addEventListener('pointermove', e => {
  if(!drawing) return;
  const pos = getPointerPos(e);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
  currentPath.push(pos);
});
canvas.addEventListener('pointerup', () => {
  drawing = false;
  if(currentPath.length) paths.push(currentPath);
});
canvas.addEventListener('pointercancel', () => drawing = false);

// Touch support
canvas.addEventListener('touchstart', e => e.preventDefault(), {passive:false});
canvas.addEventListener('touchmove', e => e.preventDefault(), {passive:false});

function redraw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  paths.forEach(path => {
    ctx.beginPath();
    ctx.moveTo(path[0].x, path[0].y);
    for(let i=1;i<path.length;i++) ctx.lineTo(path[i].x,path[i].y);
    ctx.stroke();
  });
}

document.getElementById('clearBtn').onclick = () => { ctx.clearRect(0,0,canvas.width,canvas.height); paths=[]; };
document.getElementById('undoBtn').onclick = () => { paths.pop(); redraw(); };

document.getElementById('uploadBtn').onclick = async () => {
  const dataUrl = canvas.toDataURL('image/png');
  const payload = { image: dataUrl, date: new Date().toLocaleDateString('pt-PT') };
  try {
    const response = await fetch('https://script.google.com/macros/s/AKfycbzxTV86BHS37i-OrIUE11nrMYmlr2O71DQzX-zDoBG5sI2NTuo1MCEksEE01XiOEgW6mQ/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await response.text();
    alert('Assinatura enviada com sucesso!\n' + result);
  } catch(err) {
    alert('Erro ao enviar: ' + err.message);
  }
};
</script>
</body>
</html>
